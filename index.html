<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR åœ–åƒè¾¨è­˜æ‡‰ç”¨</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        
        /* ä¸»ç•«é¢ */
        #main-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        
        #main-screen.hidden {
            display: none;
        }
        
        #main-screen h1 {
            color: #fff;
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        #main-screen .subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* ç‹€æ…‹å¡ç‰‡ */
        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 350px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .status-card h3 {
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .status-icon.checking {
            background: rgba(255,255,255,0.2);
        }
        
        .status-icon.success {
            background: rgba(74, 222, 128, 0.2);
        }
        
        .status-icon.error {
            background: rgba(248, 113, 113, 0.2);
        }
        
        .status-icon.warning {
            background: rgba(251, 191, 36, 0.2);
        }
        
        .status-text {
            flex: 1;
        }
        
        .status-text .label {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-text .detail {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* æŒ‰éˆ• */
        .btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #fff;
            border: none;
            padding: 16px 48px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
            margin: 10px;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(0, 212, 255, 0.6);
        }
        
        .btn:disabled {
            background: #666;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            box-shadow: none;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            box-shadow: none;
        }
        
        /* èªªæ˜å€å¡Š */
        .help-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 350px;
            margin-top: 20px;
        }
        
        .help-section h3 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .help-section p {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .help-section code {
            background: rgba(0,212,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00d4ff;
            font-family: monospace;
        }
        
        .help-section a {
            color: #00d4ff;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* AR å ´æ™¯å®¹å™¨ */
        #ar-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #ar-container.active {
            display: block;
        }
        
        /* AR UI */
        #ar-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        
        #ar-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        #ar-status.found {
            background: rgba(34, 197, 94, 0.8);
        }
        
        #scan-hint {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            font-size: 20px;
            cursor: pointer;
            pointer-events: auto;
        }
        
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.9);
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- ä¸»ç•«é¢ -->
    <div id="main-screen">
        <h1>ğŸ“· AR åœ–åƒè¾¨è­˜</h1>
        <p class="subtitle">æƒæç›®æ¨™åœ–åƒé¡¯ç¤º 3D æ¨¡å‹</p>
        
        <!-- ç‹€æ…‹æª¢æ¸¬ -->
        <div class="status-card">
            <h3>ğŸ“‹ ç’°å¢ƒæª¢æ¸¬</h3>
            
            <div class="status-item">
                <div class="status-icon checking" id="https-icon">ğŸ”’</div>
                <div class="status-text">
                    <div class="label">å®‰å…¨é€£ç·š</div>
                    <div class="detail" id="https-detail">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-icon checking" id="camera-icon">ğŸ“·</div>
                <div class="status-text">
                    <div class="label">ç›¸æ©Ÿ</div>
                    <div class="detail" id="camera-detail">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-icon checking" id="target-icon">ğŸ¯</div>
                <div class="status-text">
                    <div class="label">ç›®æ¨™åœ–åƒ (target.mind)</div>
                    <div class="detail" id="target-detail">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-icon checking" id="model-icon">ğŸ¨</div>
                <div class="status-text">
                    <div class="label">3D æ¨¡å‹ (model.glb)</div>
                    <div class="detail" id="model-detail">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- æŒ‰éˆ• -->
        <div id="button-area">
            <button class="btn" id="start-btn" disabled>æª¢æŸ¥ä¸­...</button>
        </div>
        <button class="btn btn-secondary" id="camera-test-btn">ğŸ“· æ¸¬è©¦ç›¸æ©Ÿ</button>
        
        <!-- èªªæ˜ -->
        <div class="help-section">
            <h3>ğŸ“ éœ€è¦çš„æª”æ¡ˆ</h3>
            <p>1. <code>target.mind</code> - ç›®æ¨™åœ–åƒæª”</p>
            <p>2. <code>model.glb</code> - 3D æ¨¡å‹æª”</p>
            <p style="margin-top: 15px;">
                <strong>è£½ä½œ target.mindï¼š</strong><br>
                å‰å¾€ <a href="https://hiukim.github.io/mind-ar-js-doc/tools/compile" target="_blank">MindAR ç·¨è­¯å™¨</a> ä¸Šå‚³åœ–ç‰‡
            </p>
        </div>
    </div>
    
    <!-- AR å®¹å™¨ -->
    <div id="ar-container"></div>
    
    <!-- AR UI -->
    <div id="ar-ui">
        <button id="back-btn">â†</button>
        <div id="ar-status">å°‹æ‰¾ç›®æ¨™ä¸­...</div>
        <div id="scan-hint">ğŸ“± è«‹å°‡ç›¸æ©Ÿå°æº–ç›®æ¨™åœ–åƒ</div>
        <div id="controls">
            <button class="control-btn" id="scale-down">â–</button>
            <button class="control-btn" id="scale-up">â•</button>
            <button class="control-btn" id="rotate-btn">ğŸ”„</button>
        </div>
    </div>
    
    <!-- ç›¸æ©Ÿæ¸¬è©¦ç”¨ -->
    <video id="test-video" style="display:none;" playsinline autoplay muted></video>

    <script>
        // ===== ç’°å¢ƒæª¢æ¸¬ =====
        const checks = {
            https: false,
            camera: false,
            target: false,
            model: false
        };
        
        // æ›´æ–°ç‹€æ…‹åœ–ç¤º
        function updateStatus(id, status, detail) {
            const icon = document.getElementById(`${id}-icon`);
            const detailEl = document.getElementById(`${id}-detail`);
            
            icon.className = 'status-icon ' + status;
            detailEl.textContent = detail;
            
            if (status === 'success') {
                icon.textContent = 'âœ“';
            } else if (status === 'error') {
                icon.textContent = 'âœ—';
            } else if (status === 'warning') {
                icon.textContent = 'âš ';
            }
        }
        
        // æª¢æŸ¥ HTTPS
        function checkHTTPS() {
            const isSecure = window.isSecureContext;
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (isSecure) {
                checks.https = true;
                updateStatus('https', 'success', isLocalhost ? 'localhost é€£ç·š' : 'HTTPS å®‰å…¨é€£ç·š');
            } else {
                updateStatus('https', 'error', 'éœ€è¦ HTTPS æˆ– localhost');
            }
        }
        
        // æª¢æŸ¥ç›¸æ©Ÿ
        async function checkCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('camera', 'error', 'ç€è¦½å™¨ä¸æ”¯æ´');
                return;
            }
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                
                if (cameras.length > 0) {
                    checks.camera = true;
                    updateStatus('camera', 'success', `æ‰¾åˆ° ${cameras.length} å€‹ç›¸æ©Ÿ`);
                } else {
                    updateStatus('camera', 'warning', 'æœªåµæ¸¬åˆ°ç›¸æ©Ÿ');
                }
            } catch (e) {
                updateStatus('camera', 'warning', 'éœ€è¦æˆæ¬Šå¾Œç¢ºèª');
                checks.camera = true; // å‡è¨­æœ‰ç›¸æ©Ÿ
            }
        }
        
        // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        async function checkFile(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (e) {
                return false;
            }
        }
        
        // æª¢æŸ¥ target.mind
        async function checkTarget() {
            const exists = await checkFile('./target.mind');
            if (exists) {
                checks.target = true;
                updateStatus('target', 'success', 'æª”æ¡ˆå·²æ‰¾åˆ°');
            } else {
                updateStatus('target', 'error', 'æª”æ¡ˆä¸å­˜åœ¨ï¼è«‹ä¸Šå‚³ target.mind');
            }
        }
        
        // æª¢æŸ¥ model.glb
        async function checkModel() {
            const exists = await checkFile('./model.glb');
            if (exists) {
                checks.model = true;
                updateStatus('model', 'success', 'æª”æ¡ˆå·²æ‰¾åˆ°');
            } else {
                updateStatus('model', 'error', 'æª”æ¡ˆä¸å­˜åœ¨ï¼è«‹ä¸Šå‚³ model.glb');
            }
        }
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        function updateButton() {
            const btn = document.getElementById('start-btn');
            const allReady = checks.https && checks.camera && checks.target && checks.model;
            
            if (allReady) {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ é–‹å§‹ AR é«”é©—';
            } else {
                btn.disabled = true;
                if (!checks.https) {
                    btn.textContent = 'âŒ éœ€è¦ HTTPS é€£ç·š';
                } else if (!checks.target) {
                    btn.textContent = 'âŒ ç¼ºå°‘ target.mind';
                } else if (!checks.model) {
                    btn.textContent = 'âŒ ç¼ºå°‘ model.glb';
                } else {
                    btn.textContent = 'âŒ ç’°å¢ƒæª¢æ¸¬å¤±æ•—';
                }
            }
        }
        
        // åŸ·è¡Œæ‰€æœ‰æª¢æŸ¥
        async function runChecks() {
            checkHTTPS();
            await checkCamera();
            await checkTarget();
            await checkModel();
            updateButton();
        }
        
        // ===== ç›¸æ©Ÿæ¸¬è©¦ =====
        document.getElementById('camera-test-btn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const video = document.getElementById('test-video');
                video.srcObject = stream;
                video.style.display = 'block';
                video.style.position = 'fixed';
                video.style.top = '0';
                video.style.left = '0';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                video.style.zIndex = '9999';
                
                // é»æ“Šé—œé–‰
                video.onclick = () => {
                    stream.getTracks().forEach(t => t.stop());
                    video.style.display = 'none';
                    video.srcObject = null;
                    
                    // é‡æ–°æª¢æŸ¥
                    checks.camera = true;
                    updateStatus('camera', 'success', 'ç›¸æ©Ÿæ­£å¸¸é‹ä½œ');
                    updateButton();
                };
                
                alert('ç›¸æ©Ÿæ­£å¸¸ï¼é»æ“Šç•«é¢é—œé–‰');
                
            } catch (e) {
                alert('ç›¸æ©ŸéŒ¯èª¤: ' + e.message + '\n\nè«‹ç¢ºä¿:\n1. ä½¿ç”¨ HTTPS æˆ– localhost\n2. å·²å…è¨±ç›¸æ©Ÿæ¬Šé™');
            }
        });
        
        // ===== AR åŠŸèƒ½ =====
        let arStarted = false;
        
        document.getElementById('start-btn').addEventListener('click', startAR);
        
        async function startAR() {
            if (arStarted) return;
            
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader" style="width:20px;height:20px;display:inline-block;vertical-align:middle;margin-right:10px;"></span>è¼‰å…¥ä¸­...';
            
            try {
                // å‹•æ…‹è¼‰å…¥ A-Frame å’Œ MindAR
                await loadScript('https://aframe.io/releases/1.4.0/aframe.min.js');
                await loadScript('https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js');
                
                // å‰µå»º AR å ´æ™¯
                createARScene();
                
            } catch (e) {
                console.error('AR è¼‰å…¥å¤±æ•—:', e);
                alert('AR è¼‰å…¥å¤±æ•—: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'ğŸš€ é–‹å§‹ AR é«”é©—';
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error('ç„¡æ³•è¼‰å…¥: ' + src));
                document.head.appendChild(script);
            });
        }
        
        function createARScene() {
            const container = document.getElementById('ar-container');
            
            container.innerHTML = `
                <a-scene
                    id="ar-scene"
                    mindar-image="imageTargetSrc: ./target.mind; autoStart: true; uiLoading: no; uiScanning: no; uiError: no;"
                    color-space="sRGB"
                    renderer="colorManagement: true"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false"
                    embedded
                    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;"
                >
                    <a-assets>
                        <a-asset-item id="model" src="./model.glb"></a-asset-item>
                    </a-assets>
                    
                    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
                    
                    <a-entity id="target" mindar-image-target="targetIndex: 0">
                        <a-gltf-model
                            id="ar-model"
                            src="#model"
                            position="0 0 0"
                            rotation="0 0 0"
                            scale="0.5 0.5 0.5"
                            animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"
                        ></a-gltf-model>
                        
                        <a-ring
                            color="#00d4ff"
                            radius-inner="0.3"
                            radius-outer="0.35"
                            position="0 0 0"
                            rotation="-90 0 0"
                            opacity="0.5"
                            animation="property: scale; to: 1.2 1.2 1.2; loop: true; dir: alternate; dur: 1000"
                        ></a-ring>
                    </a-entity>
                    
                    <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
                    <a-light type="directional" color="#ffffff" intensity="1" position="0 2 1"></a-light>
                </a-scene>
            `;
            
            container.classList.add('active');
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('ar-ui').style.display = 'block';
            
            // ç­‰å¾…å ´æ™¯è¼‰å…¥
            const scene = document.getElementById('ar-scene');
            
            scene.addEventListener('loaded', () => {
                console.log('A-Frame å ´æ™¯å·²è¼‰å…¥');
                arStarted = true;
            });
            
            // ç›£è½ç›®æ¨™æª¢æ¸¬
            setTimeout(() => {
                const target = document.getElementById('target');
                if (target) {
                    target.addEventListener('targetFound', () => {
                        document.getElementById('ar-status').textContent = 'âœ“ å·²æ‰¾åˆ°ç›®æ¨™ï¼';
                        document.getElementById('ar-status').classList.add('found');
                        document.getElementById('scan-hint').style.display = 'none';
                    });
                    
                    target.addEventListener('targetLost', () => {
                        document.getElementById('ar-status').textContent = 'å°‹æ‰¾ç›®æ¨™ä¸­...';
                        document.getElementById('ar-status').classList.remove('found');
                        document.getElementById('scan-hint').style.display = 'block';
                    });
                }
            }, 1000);
        }
        
        // è¿”å›æŒ‰éˆ•
        document.getElementById('back-btn').addEventListener('click', () => {
            location.reload();
        });
        
        // ç¸®æ”¾æ§åˆ¶
        let currentScale = 0.5;
        
        document.getElementById('scale-up').addEventListener('click', () => {
            currentScale = Math.min(currentScale + 0.1, 2);
            const model = document.getElementById('ar-model');
            if (model) model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
        });
        
        document.getElementById('scale-down').addEventListener('click', () => {
            currentScale = Math.max(currentScale - 0.1, 0.1);
            const model = document.getElementById('ar-model');
            if (model) model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
        });
        
        // æ—‹è½‰æ§åˆ¶
        let isRotating = true;
        document.getElementById('rotate-btn').addEventListener('click', () => {
            isRotating = !isRotating;
            const model = document.getElementById('ar-model');
            if (model) {
                if (isRotating) {
                    model.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear');
                } else {
                    model.removeAttribute('animation');
                }
            }
        });
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œæª¢æŸ¥
        window.addEventListener('DOMContentLoaded', runChecks);
    </script>
</body>
</html>
