<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU é‹ä½œæ¨¡æ“¬ï¼šå„€è¡¨æ¿ä½ˆå±€ç‰ˆ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: #e0f7fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        /* ä¸»è¦å®¹å™¨ï¼šæ”¹ç‚ºæ©«å‘æ’åˆ— (Row) */
        .container {
            display: flex;
            flex-direction: row; 
            width: 1100px; /* åŠ å¯¬ä»¥å®¹ç´å·¦å³å…©é‚Š */
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            border: 4px solid #4dd0e1;
        }

        /* === å·¦å´ï¼šæ§åˆ¶é¢æ¿ === */
        .left-panel {
            width: 300px; /* å›ºå®šå¯¬åº¦ */
            background: #f1f8e9;
            border-right: 2px solid #ddd;
            padding: 25px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            z-index: 10;
        }

        .panel-header {
            border-bottom: 2px solid #ccc;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 22px;
            font-weight: bold;
            color: #2e7d32;
            margin: 0 0 5px 0;
        }
        
        .panel-subtitle {
            font-size: 14px;
            color: #555;
            margin: 0;
        }

        /* æ­¥é©Ÿèªªæ˜å€ */
        .step-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #c5e1a5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-grow: 1; /* ä½”æ“šä¸­é–“ç©ºé–“ */
            margin-bottom: 20px;
        }

        .step-title {
            font-weight: bold;
            color: #00838f;
            font-size: 18px;
            margin-bottom: 10px;
            display: block;
        }

        .step-desc {
            font-size: 15px;
            color: #333;
            line-height: 1.6;
        }

        /* æŒ‰éˆ•å€ (ç½®æ–¼å·¦å´åº•éƒ¨) */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: transform 0.2s, background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #btn-step { background-color: #00bcd4; color: white; }
        #btn-step:hover { background-color: #00acc1; transform: translateY(-2px); }
        #btn-step:disabled { background-color: #cfd8dc; cursor: not-allowed; transform: none; }

        #btn-reset { background-color: #ff7043; color: white; }
        #btn-reset:hover { background-color: #f4511e; transform: translateY(-2px); }

        /* === å³å´ï¼šå‹•ç•«å€ === */
        .right-panel {
            flex-grow: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            background: white;
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        /* SVG å…ƒç´ æ¨£å¼ (ä¿æŒä¸è®Š) */
        .component-box { stroke: #333; stroke-width: 3; rx: 10; ry: 10; fill: #fff; }
        .ram-cell { fill: #f5f5f5; stroke: #ccc; stroke-width: 2; }
        .ram-active { fill: #fff9c4 !important; stroke: #fbc02d !important; stroke-width: 4 !important; }
        .label-text { font-weight: bold; fill: #455a64; pointer-events: none; }
        .value-text { font-family: monospace; font-size: 16px; fill: #333; pointer-events: none; }
        .emoji { font-size: 30px; pointer-events: none; }
        .bus-path { fill: none; stroke: #b0bec5; stroke-width: 12; stroke-linecap: round; stroke-linejoin: round; }
        
        #packet-group { display: none; }
        #packet-body { fill: #ff4081; stroke: white; stroke-width: 3; }
        #packet-text { fill: white; font-weight: bold; font-family: monospace; font-size: 14px; text-anchor: middle; dominant-baseline: middle; }
        .highlight-cpu { stroke: #ff9800; stroke-width: 5; filter: drop-shadow(0 0 8px rgba(255, 152, 0, 0.6)); }
    </style>
</head>
<body>

    <div class="container">
        <!-- å·¦å´é¢æ¿ -->
        <div class="left-panel">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ¤– CPU æ¨¡æ“¬å™¨</h2>
                <p class="panel-subtitle">æŒ‡ä»¤é€±æœŸæ¼”ç¤º</p>
            </div>

            <div class="step-info">
                <span class="step-title" id="step-title">æº–å‚™å°±ç·’</span>
                <div class="step-desc" id="step-desc">
                    <strong>ä»»å‹™æ¸…å–®ï¼š</strong><br>
                    1. å–å‡ºæ•¸å­— 10<br>
                    2. åŠ ä¸Šæ•¸å­— 20<br>
                    3. çµæœå¯«å…¥ä½ç½® 03<br><br>
                    è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ã€‚
                </div>
            </div>

            <div class="controls">
                <button id="btn-step" onclick="runNextStep()">ä¸‹ä¸€æ­¥ â¡</button>
                <button id="btn-reset" onclick="resetSimulation()">é‡ç½® âŸ²</button>
            </div>
        </div>

        <!-- å³å´å‹•ç•« -->
        <div class="right-panel">
            <svg viewBox="0 0 850 600">
                <!-- ç¸½ç·š (Buses) -->
                <path d="M150 300 L700 300" class="bus-path" />
                <path d="M200 300 L200 550" class="bus-path" /> 
                <path d="M600 300 L600 150" class="bus-path" />
                <path d="M600 300 L600 450" class="bus-path" />

                <!-- === RAM === -->
                <g transform="translate(50, 280)">
                    <rect width="250" height="280" fill="#e1f5fe" stroke="#0288d1" stroke-width="3" rx="10" />
                    <text x="125" y="-15" text-anchor="middle" class="label-text" font-size="20">è¨˜æ†¶é«” (RAM)</text>

                    <!-- æ ¼å­ 00 -->
                    <rect id="ram-0" x="25" y="20" width="200" height="40" class="ram-cell" />
                    <text x="10" y="45" class="label-text">00:</text>
                    <text x="125" y="45" text-anchor="middle" class="value-text">LOAD 10</text>

                    <!-- æ ¼å­ 01 -->
                    <rect id="ram-1" x="25" y="70" width="200" height="40" class="ram-cell" />
                    <text x="10" y="95" class="label-text">01:</text>
                    <text x="125" y="95" text-anchor="middle" class="value-text">ADD 20</text>

                    <!-- æ ¼å­ 02 -->
                    <rect id="ram-2" x="25" y="120" width="200" height="40" class="ram-cell" />
                    <text x="10" y="145" class="label-text">02:</text>
                    <text x="125" y="145" text-anchor="middle" class="value-text">STORE</text>

                    <!-- æ•¸æ“šå€åˆ†éš” -->
                    <line x1="10" y1="175" x2="240" y2="175" stroke="#81d4fa" stroke-dasharray="5,5" stroke-width="2" />

                    <!-- æ•¸æ“š 10 -->
                    <rect id="ram-data-10" x="25" y="190" width="90" height="30" fill="#e0e0e0" stroke="#999" />
                    <text x="70" y="210" text-anchor="middle" class="value-text" font-weight="bold">10</text>
                    
                    <!-- æ•¸æ“š 20 -->
                    <rect id="ram-data-20" x="135" y="190" width="90" height="30" fill="#e0e0e0" stroke="#999" />
                    <text x="180" y="210" text-anchor="middle" class="value-text" font-weight="bold">20</text>

                    <!-- çµæœå­˜æ”¾å€ 03 -->
                    <rect id="ram-3" x="25" y="230" width="200" height="40" class="ram-cell" style="fill: #fff;" />
                    <text x="10" y="255" class="label-text">03:</text>
                    <text id="ram-3-text" x="125" y="255" text-anchor="middle" class="value-text" fill="#999">(ç©º)</text>
                </g>

                <!-- === CPU === -->
                <rect x="450" y="50" width="350" height="520" fill="none" stroke="#555" stroke-width="2" stroke-dasharray="10,5" rx="20" />
                <text x="625" y="40" text-anchor="middle" font-size="24" fill="#333" font-weight="bold">CPU (ä¸­å¤®è™•ç†å™¨)</text>

                <!-- CU -->
                <g id="unit-cu" transform="translate(500, 80)">
                    <rect width="250" height="120" fill="#fff9c4" class="component-box" />
                    <text x="30" y="60" class="emoji">ğŸ¤–</text>
                    <text x="125" y="40" text-anchor="middle" class="label-text" font-size="18">æ§åˆ¶å–®å…ƒ (CU)</text>
                    <text x="125" y="90" text-anchor="middle" class="value-text" id="ir-text" fill="#e65100">æŒ‡ä»¤: ...</text>
                </g>

                <!-- ALU -->
                <g id="unit-alu" transform="translate(500, 380)">
                    <rect width="250" height="150" fill="#ffebee" class="component-box" />
                    <text x="30" y="75" class="emoji">ğŸ§®</text>
                    <text x="125" y="40" text-anchor="middle" class="label-text" font-size="18">ç®—è¡“é‚è¼¯å–®å…ƒ</text>
                    
                    <rect x="60" y="60" width="130" height="60" fill="#fff" stroke="#ff5252" stroke-width="2" rx="5" />
                    <text x="125" y="80" text-anchor="middle" font-size="12" fill="#999">ç´¯åŠ å™¨ (ACC)</text>
                    <text id="acc-text" x="125" y="105" text-anchor="middle" font-size="24" font-weight="bold" fill="#d32f2f">0</text>
                </g>

                <!-- æ•¸æ“šåŒ… -->
                <g id="packet-group">
                    <circle id="packet-body" cx="0" cy="0" r="25" />
                    <text id="packet-text" x="0" y="2">DATA</text>
                </g>
            </svg>
        </div>
    </div>

    <script>
        let step = 0;
        const titleEl = document.getElementById('step-title');
        const descEl = document.getElementById('step-desc');
        const btnStep = document.getElementById('btn-step');
        
        const packetGroup = document.getElementById('packet-group');
        const packetText = document.getElementById('packet-text');
        const irText = document.getElementById('ir-text');
        const accText = document.getElementById('acc-text');
        
        const unitCU = document.querySelector('#unit-cu rect');
        const unitALU = document.querySelector('#unit-alu rect');
        const ram3Text = document.getElementById('ram-3-text');
        const ram3Box = document.getElementById('ram-3');

        const P = {
            RAM_0: { x: 200, y: 320 },
            RAM_1: { x: 200, y: 370 },
            RAM_2: { x: 200, y: 420 },
            RAM_DATA_10: { x: 120, y: 490 },
            RAM_DATA_20: { x: 230, y: 490 },
            RAM_3: { x: 200, y: 530 },
            BUS_RAM_JUNCTION: { x: 200, y: 300 },
            BUS_CPU_JUNCTION: { x: 600, y: 300 },
            CU: { x: 600, y: 150 }, 
            ALU: { x: 600, y: 450 }
        };

        function movePacket(pathPoints, text, color = "#ff4081", speed = 1000) {
            packetGroup.style.display = 'block';
            packetText.textContent = text;
            document.getElementById('packet-body').style.fill = color;

            const keyframes = pathPoints.map(p => ({
                transform: `translate(${p.x}px, ${p.y}px)`
            }));

            return packetGroup.animate(keyframes, {
                duration: speed,
                fill: 'forwards',
                easing: 'ease-in-out'
            }).finished;
        }

        function updateStatus(title, desc) {
            titleEl.textContent = title;
            descEl.innerHTML = desc;
        }

        function highlight(elementId, active) {
            const el = document.getElementById(elementId);
            if(active) el.classList.add('ram-active');
            else el.classList.remove('ram-active');
        }

        function highlightBox(element, active) {
            if(active) element.classList.add('highlight-cpu');
            else element.classList.remove('highlight-cpu');
        }

        async function runNextStep() {
            btnStep.disabled = true;
            step++;

            switch (step) {
                // === æŒ‡ä»¤ 1: LOAD ===
                case 1: 
                    updateStatus("1. å–æŒ‡ä»¤ (Fetch)", "å¾è¨˜æ†¶é«” 00 è®€å–æŒ‡ä»¤ï¼šã€Œè¼‰å…¥ 10ã€");
                    highlight('ram-0', true);
                    await movePacket([P.RAM_0, P.BUS_RAM_JUNCTION, P.BUS_CPU_JUNCTION, P.CU], "LOAD 10", "#7e57c2");
                    irText.textContent = "LOAD 10";
                    highlightBox(unitCU, true);
                    packetGroup.style.display = 'none';
                    break;

                case 2: 
                    updateStatus("2. åŸ·è¡Œ (Execute)", "å°‡æ•¸æ“š 10 æ”¾å…¥ç´¯åŠ å™¨(ACC)ã€‚");
                    highlight('ram-0', false);
                    highlightBox(unitCU, false);
                    highlight('ram-data-10', true);
                    await movePacket([P.RAM_DATA_10, P.BUS_RAM_JUNCTION, P.BUS_CPU_JUNCTION, P.ALU], "10", "#29b6f6");
                    accText.textContent = "10";
                    highlight('ram-data-10', false);
                    packetGroup.style.display = 'none';
                    highlightBox(unitALU, true);
                    setTimeout(() => highlightBox(unitALU, false), 500);
                    break;

                // === æŒ‡ä»¤ 2: ADD ===
                case 3: 
                    updateStatus("3. å–æŒ‡ä»¤ (Fetch)", "å¾è¨˜æ†¶é«” 01 è®€å–ï¼šã€ŒADD 20ã€");
                    highlight('ram-1', true);
                    await movePacket([P.RAM_1, P.BUS_RAM_JUNCTION, P.BUS_CPU_JUNCTION, P.CU], "ADD 20", "#7e57c2");
                    irText.textContent = "ADD 20";
                    highlightBox(unitCU, true);
                    packetGroup.style.display = 'none';
                    break;

                case 4: 
                    updateStatus("4. åŸ·è¡Œ (Execute)", "å–å‡ºæ•¸æ“š 20ï¼Œèˆ‡ ACC ç›¸åŠ ã€‚<br>10 + 20 = 30");
                    highlight('ram-1', false);
                    highlightBox(unitCU, false);
                    highlight('ram-data-20', true);
                    await movePacket([P.RAM_DATA_20, P.BUS_RAM_JUNCTION, P.BUS_CPU_JUNCTION, P.ALU], "20", "#29b6f6");
                    packetGroup.style.display = 'none';
                    highlightBox(unitALU, true);
                    await new Promise(r => setTimeout(r, 500));
                    accText.textContent = "30";
                    accText.style.fill = "#d50000"; 
                    highlight('ram-data-20', false);
                    break;

                // === æŒ‡ä»¤ 3: STORE ===
                case 5: 
                    updateStatus("5. å–æŒ‡ä»¤ (Fetch)", "å¾è¨˜æ†¶é«” 02 è®€å–ï¼šã€ŒSTOREã€");
                    highlightBox(unitALU, false);
                    highlight('ram-2', true);
                    await movePacket([P.RAM_2, P.BUS_RAM_JUNCTION, P.BUS_CPU_JUNCTION, P.CU], "STORE", "#7e57c2");
                    irText.textContent = "STORE";
                    highlightBox(unitCU, true);
                    packetGroup.style.display = 'none';
                    break;

                case 6: // å¯«å›
                    updateStatus("6. å¯«å› (Store)", "å°‡çµæœ 30 å­˜å…¥ä½å€ 03ã€‚");
                    highlight('ram-2', false);
                    highlightBox(unitCU, false);
                    highlightBox(unitALU, true);
                    await movePacket([P.ALU, P.BUS_CPU_JUNCTION, P.BUS_RAM_JUNCTION, P.RAM_3], "30", "#ff4081");
                    ram3Text.textContent = "30";
                    ram3Text.style.fill = "red";
                    ram3Text.style.fontWeight = "bold";
                    ram3Box.style.fill = "#ffcdd2";
                    packetGroup.style.display = 'none';
                    highlightBox(unitALU, false);
                    highlight('ram-3', true);
                    btnStep.textContent = "å®Œæˆ (é‡ç½®)";
                    btnStep.onclick = resetSimulation;
                    break;
            }

            if (step < 6) btnStep.disabled = false;
        }

        function resetSimulation() {
            location.reload();
        }
    </script>
</body>
</html>