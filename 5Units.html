<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦®è«¾ä¾æ›¼æ¶æ§‹äº’å‹•æ¼”ç¤º (åˆä¸­ç‰ˆ) - è·¯å¾‘ä¿®æ­£ç‰ˆ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            position: relative;
            width: 800px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            font-family: inherit;
            font-weight: bold;
        }
        
        #btn-next { background-color: #4CAF50; color: white; }
        #btn-next:hover { background-color: #45a049; transform: scale(1.05); }
        #btn-next:disabled { background-color: #ccc; transform: none; cursor: not-allowed; }
        
        #btn-reset { background-color: #ff9800; color: white; }
        #btn-reset:hover { background-color: #e68900; transform: scale(1.05); }

        svg { width: 100%; height: 100%; }

        .unit-box {
            stroke-width: 3;
            stroke: #333;
            transition: filter 0.3s, stroke 0.3s;
        }

        .unit-text {
            font-size: 20px;
            font-weight: bold;
            fill: #333;
            pointer-events: none;
            text-anchor: middle;
        }
        
        .unit-icon {
            font-size: 40px;
            pointer-events: none;
            text-anchor: middle;
        }

        .bus-line {
            stroke: #cbd5e0;
            stroke-width: 8;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* æ•¸æ“šåŒ…ç¾¤çµ„æ¨£å¼ */
        #data-group {
            display: none; /* åˆå§‹éš±è— */
            cursor: default;
        }
        
        #data-circle {
            fill: #ff4757;
            stroke: white;
            stroke-width: 2;
        }
        
        #data-text {
            fill: white;
            font-size: 14px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle; /* å‚ç›´å±…ä¸­ */
            pointer-events: none;
        }

        #status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            box-sizing: border-box;
        }

        .active-unit {
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            stroke: #ff9800;
        }
    </style>
</head>
<body>

    <h1>é›»è…¦é‹ä½œæµç¨‹æ¼”ç¤º (è·¯å¾‘ä¿®æ­£ç‰ˆ)</h1>
    <p>ä»»å‹™ï¼šè¨ˆç®— 1 + 2 = ? (è§€å¯Ÿå°çƒå¦‚ä½•æ²¿è‘—ç·šè·¯ç§»å‹•)</p>

    <div class="container">
        <svg viewBox="0 0 800 550">
            <!-- èƒŒæ™¯é€£æ¥ç·š (Bus) - å®šç¾©æ¸…æ¥šçš„è»Œé“ -->
            <!-- åº•éƒ¨æ©«å‘ç¸½ç·š -->
            <path d="M150 400 L650 400" class="bus-line" />
            <!-- é€£æ¥ Input -->
            <path d="M150 250 L150 400" class="bus-line" />
            <!-- é€£æ¥ Memory -->
            <path d="M400 350 L400 400" class="bus-line" />
            <!-- é€£æ¥ Output -->
            <path d="M650 250 L650 400" class="bus-line" />
            <!-- Memory åˆ° CPU çš„å‚ç›´ç¸½ç·š -->
            <path d="M400 250 L400 350" class="bus-line" />
            <!-- CPU å…§éƒ¨æ©«å‘ç¸½ç·š -->
            <path d="M345 150 L455 150" class="bus-line" />
            <!-- é€£æ¥ CPU åˆ° å‚ç›´ç¸½ç·š -->
            <path d="M400 150 L400 250" class="bus-line" />

            <!-- CPU å¤§æ¡† -->
            <rect x="280" y="50" width="240" height="220" rx="10" fill="none" stroke="#999" stroke-dasharray="5,5" stroke-width="2" />
            <text x="400" y="40" text-anchor="middle" fill="#666" font-size="16">ä¸­å¤®è™•ç†å™¨ (CPU)</text>

            <!-- 1. è¼¸å…¥å–®å…ƒ -->
            <g id="unit-input">
                <rect x="50" y="150" width="200" height="100" rx="10" fill="#e8f5e9" class="unit-box" />
                <text x="150" y="190" class="unit-icon">âŒ¨ï¸</text>
                <text x="150" y="220" class="unit-text">è¼¸å…¥å–®å…ƒ</text>
            </g>

            <!-- 2. è¨˜æ†¶å–®å…ƒ -->
            <g id="unit-memory">
                <rect x="300" y="350" width="200" height="100" rx="10" fill="#fff3e0" class="unit-box" />
                <text x="400" y="390" class="unit-icon">ğŸ’¾</text>
                <text x="400" y="420" class="unit-text">è¨˜æ†¶å–®å…ƒ</text>
            </g>

            <!-- 3. æ§åˆ¶å–®å…ƒ (CU) -->
            <g id="unit-cu">
                <rect x="300" y="80" width="90" height="140" rx="10" fill="#ffebee" class="unit-box" />
                <text x="345" y="140" class="unit-icon">ğŸ‘®</text>
                <text x="345" y="170" class="unit-text" style="font-size:16px">æ§åˆ¶å–®å…ƒ</text>
            </g>

            <!-- 4. ç®—è¡“é‚è¼¯å–®å…ƒ (ALU) -->
            <g id="unit-alu">
                <rect x="410" y="80" width="90" height="140" rx="10" fill="#e3f2fd" class="unit-box" />
                <text x="455" y="140" class="unit-icon">ğŸ§®</text>
                <text x="455" y="170" class="unit-text" style="font-size:16px">ç®—è¡“é‚è¼¯</text>
            </g>

            <!-- 5. è¼¸å‡ºå–®å…ƒ -->
            <g id="unit-output">
                <rect x="550" y="150" width="200" height="100" rx="10" fill="#f3e5f5" class="unit-box" />
                <text x="650" y="190" class="unit-icon">ğŸ–¥ï¸</text>
                <text x="650" y="220" class="unit-text">è¼¸å‡ºå–®å…ƒ</text>
                <rect x="580" y="160" width="140" height="40" fill="#333" rx="5" />
                <text id="screen-text" x="650" y="188" fill="#0f0" font-family="monospace" font-size="24" text-anchor="middle"></text>
            </g>

            <!-- ç§»å‹•çš„æ•¸æ“šåŒ…ç¾¤çµ„ (å°‡åœ“é»å’Œæ–‡å­—ç¶å®šåœ¨ä¸€èµ·) -->
            <g id="data-group">
                <circle id="data-circle" cx="0" cy="0" r="22" />
                <text id="data-text" x="0" y="2">data</text>
            </g>

        </svg>
        <div id="status-bar">é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹é‹ä½œ...</div>
    </div>

    <div class="controls">
        <button id="btn-next" onclick="nextStep()">ä¸‹ä¸€æ­¥ â–¶</button>
        <button id="btn-reset" onclick="resetSim()">é‡ç½® âŸ²</button>
    </div>

    <script>
        let step = 0;
        const statusText = document.getElementById('status-bar');
        const dataGroup = document.getElementById('data-group');
        const dataCircle = document.getElementById('data-circle');
        const dataText = document.getElementById('data-text');
        const screenText = document.getElementById('screen-text');
        const btnNext = document.getElementById('btn-next');

        const units = {
            input: document.querySelector('#unit-input rect'),
            memory: document.querySelector('#unit-memory rect'),
            cu: document.querySelector('#unit-cu rect'),
            alu: document.querySelector('#unit-alu rect'),
            output: document.querySelector('#unit-output rect')
        };

        // å®šç¾©åæ¨™é» (é€™äº›é»å°æ‡‰ SVG ä¸Šçš„ä½ç½®)
        const POS = {
            INPUT: { x: 150, y: 200 },
            INPUT_CORNER: { x: 150, y: 400 }, // è½‰è§’
            MEMORY: { x: 400, y: 400 },
            CPU_BUS_JUNCTION: { x: 400, y: 150 }, // CPU å…§éƒ¨ç¸½ç·šäº¤ç•Œ
            CU: { x: 345, y: 150 },
            ALU: { x: 455, y: 150 },
            OUTPUT_CORNER: { x: 650, y: 400 }, // è½‰è§’
            OUTPUT: { x: 650, y: 200 }
        };

        function clearHighlights() {
            Object.values(units).forEach(el => el.classList.remove('active-unit'));
        }

        // ä½¿ç”¨ Web Animations API è™•ç†å¤šæ®µè·¯å¾‘ç§»å‹•
        // points æ˜¯ä¸€å€‹åŒ…å« {x, y} å°è±¡çš„é™£åˆ—
        function animatePath(points, text, color = "#ff4757", speed = 1000) {
            // 1. è¨­ç½®é¡¯ç¤ºèˆ‡å…§å®¹
            dataGroup.style.display = 'block';
            dataText.textContent = text;
            dataCircle.style.fill = color;

            // 2. æ§‹å»ºé—œéµå¹€ (Keyframes)
            // å°‡ x, y åæ¨™è½‰æ›ç‚º CSS transform: translate(x, y)
            const keyframes = points.map(p => ({
                transform: `translate(${p.x}px, ${p.y}px)`
            }));

            // 3. åŸ·è¡Œå‹•ç•«
            const animation = dataGroup.animate(
                keyframes, 
                {
                    duration: speed,
                    fill: 'forwards', // å‹•ç•«çµæŸå¾Œåœç•™åœ¨æœ€å¾Œä½ç½®
                    easing: 'linear'  // ç·šæ€§ç§»å‹•ï¼Œè®“è½‰å½è™•ä¸å¡é “
                }
            );

            return animation.finished; // è¿”å› Promise ä»¥ä¾¿éˆå¼èª¿ç”¨
        }

        function setPosition(pos) {
            dataGroup.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
        }

        async function nextStep() {
            step++;
            clearHighlights();
            btnNext.disabled = true; // å‹•ç•«ä¸­ç¦ç”¨æŒ‰éˆ•

            switch(step) {
                case 1: // è¼¸å…¥ -> è¨˜æ†¶é«” (èµ°ç›´è§’)
                    statusText.textContent = "1. è¼¸å…¥å–®å…ƒï¼šæ•¸æ“šé€²å…¥ï¼Œé€šéç¸½ç·šå‚³å¾€è¨˜æ†¶é«”";
                    units.input.classList.add('active-unit');
                    
                    // ç¬é–“å‡ºç¾åœ¨èµ·é»
                    setPosition(POS.INPUT); 
                    
                    // è¦åŠƒè·¯å¾‘ï¼šèµ·é» -> ä¸‹æ–¹è½‰è§’ -> è¨˜æ†¶é«”
                    await animatePath([
                        POS.INPUT, 
                        POS.INPUT_CORNER, 
                        POS.MEMORY
                    ], "1+2", "#ff4757", 1500);
                    
                    units.input.classList.remove('active-unit');
                    units.memory.classList.add('active-unit');
                    break;

                case 2: // è¨˜æ†¶é«” -> CU (èµ°ç›´è§’)
                    statusText.textContent = "2. è¨˜æ†¶å–®å…ƒ -> æ§åˆ¶å–®å…ƒï¼šCPU è®€å–æŒ‡ä»¤";
                    units.memory.classList.add('active-unit');

                    // è·¯å¾‘ï¼šè¨˜æ†¶é«” -> å¾€ä¸Šåˆ° CPU é«˜åº¦ -> å¾€å·¦åˆ° CU
                    await animatePath([
                        POS.MEMORY,
                        POS.CPU_BUS_JUNCTION,
                        POS.CU
                    ], "1+2", "#ff4757", 1500);

                    units.memory.classList.remove('active-unit');
                    units.cu.classList.add('active-unit');
                    break;

                case 3: // CU -> ALU (ç›´ç·š)
                    statusText.textContent = "3. è§£ç¢¼èˆ‡åŸ·è¡Œï¼šCU æŒ‡æ® ALU é€²è¡Œé‹ç®—";
                    units.cu.classList.add('active-unit');
                    
                    // è·¯å¾‘ï¼šCU -> ALU
                    await animatePath([
                        POS.CU,
                        POS.ALU
                    ], "1+2", "#ff4757", 800);

                    // é‹ç®—ç‰¹æ•ˆ
                    units.cu.classList.remove('active-unit');
                    units.alu.classList.add('active-unit');
                    
                    // é–ƒçˆä¸€ä¸‹ä»£è¡¨è¨ˆç®—ä¸­
                    dataCircle.style.fill = "#fff";
                    setTimeout(() => {
                        dataText.textContent = "3"; 
                        dataCircle.style.fill = "#9c27b0";
                        statusText.textContent = "3. é‹ç®—å®Œæˆï¼çµæœè®Šæˆäº† 3";
                    }, 300);
                    break;

                case 4: // ALU -> è¨˜æ†¶é«” (èµ°ç›´è§’)
                    statusText.textContent = "4. å¯«å›ï¼šå°‡çµæœ 3 å­˜å›è¨˜æ†¶é«”";
                    units.alu.classList.remove('active-unit');
                    
                    // è·¯å¾‘ï¼šALU -> ä¸­é–“äº¤ç•Œ -> å¾€ä¸‹åˆ°è¨˜æ†¶é«”
                    await animatePath([
                        POS.ALU,
                        POS.CPU_BUS_JUNCTION,
                        POS.MEMORY
                    ], "3", "#9c27b0", 1500);
                    
                    units.memory.classList.add('active-unit');
                    break;

                case 5: // è¨˜æ†¶é«” -> è¼¸å‡º (èµ°ç›´è§’)
                    statusText.textContent = "5. è¨˜æ†¶å–®å…ƒ -> è¼¸å‡ºå–®å…ƒï¼šæº–å‚™é¡¯ç¤ºçµæœ";
                    units.memory.classList.add('active-unit');
                    
                    // è·¯å¾‘ï¼šè¨˜æ†¶é«” -> å³ä¸‹è½‰è§’ -> ä¸Šæ–¹è¼¸å‡ºå–®å…ƒ
                    await animatePath([
                        POS.MEMORY,
                        POS.OUTPUT_CORNER,
                        POS.OUTPUT
                    ], "3", "#2196F3", 1500);
                    
                    units.memory.classList.remove('active-unit');
                    units.output.classList.add('active-unit');
                    break;

                case 6: // é¡¯ç¤ºçµæœ
                    statusText.textContent = "å®Œæˆï¼åœ¨è¢å¹•ä¸Šçœ‹åˆ°çµæœ";
                    dataGroup.style.display = 'none'; // æ•¸æ“šåŒ…æ¶ˆå¤±
                    screenText.textContent = "Result: 3";
                    units.output.classList.add('active-unit');
                    
                    btnNext.textContent = "æ¼”ç¤ºçµæŸ";
                    return; // çµæŸï¼Œä¸æ¢å¾©æŒ‰éˆ•
            }
            
            if (step < 6) {
                btnNext.disabled = false;
            }
        }

        function resetSim() {
            step = 0;
            clearHighlights();
            statusText.textContent = "é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹é‹ä½œ...";
            dataGroup.style.display = 'none';
            screenText.textContent = "";
            
            // å–æ¶ˆæ‰€æœ‰é€²è¡Œä¸­çš„å‹•ç•« (é‡ç½®æ¨£å¼)
            dataGroup.getAnimations().forEach(anim => anim.cancel());
            
            btnNext.textContent = "ä¸‹ä¸€æ­¥ â–¶";
            btnNext.disabled = false;
            btnNext.style.backgroundColor = "#4CAF50";
        }
    </script>
</body>
</html>