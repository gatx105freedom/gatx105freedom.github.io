<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart.js 移動平均演示 (嚴格模式 N=4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* 基礎樣式和字體 */
        body {
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1 {
            color: #0056b3;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f7fa;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        /* 圖表容器 */
        #chartContainer {
            width: 100%; 
            max-width: 800px;
            margin: 20px auto 0;
            border: 1px solid #ccc;
            background-color: #fff;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 20px;
            box-sizing: border-box;
        }
        /* 控制按鈕樣式 */
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-start { background-color: #28a745; color: white; }
        .btn-stop { background-color: #ffc107; color: #333; }
        .btn-reset { background-color: #007bff; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .info-box {
            margin-top: 25px;
            border-radius: 8px;
        }

        /* 表格高亮樣式 - 當前計算的原始數據點 */
        .highlight-active-raw {
            background-color: #d1fae5 !important; /* 綠色背景 */
            font-weight: 600;
            color: #065f46 !important; /* 深綠色文字 */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* 表格高亮樣式 - 計算出的移動平均值 */
        .highlight-ma {
            background-color: #bfdbfe !important; /* 藍色背景 */
            font-weight: 600;
            color: #1e40af !important; /* 深藍色文字 */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* 等待中的樣式 */
        .highlight-waiting {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <h1>數據可視化：移動平均動畫演示 (嚴格模式 N=4)</h1>
    <p class="mb-4 text-gray-600 text-sm">說明：嚴格模式下，前 N-1 筆數據因樣本不足，不計算移動平均值。</p>

    <div class="flex flex-wrap gap-4 mb-4 items-center">
        <div class="legend">
            <span class="legend-item text-red-600">■ 原始溫度 (Raw)</span>
            <span class="legend-item text-blue-600">■ 移動平均 (MA)</span>
            <span class="legend-item text-green-600">■ 當前計算窗口 (Active)</span>
        </div>
    </div>
    
    <div id="controls" class="flex flex-wrap gap-4 mb-6">
        <button id="startButton" class="btn btn-start" onclick="startAnimation()">開始演示</button>
        <button id="stopButton" class="btn btn-stop" onclick="stopAnimation()" disabled>暫停演示</button>
        <button id="resetButton" class="btn btn-reset" onclick="resetChart()" disabled>重置</button>
    </div>

    <div id="chartContainer" class="rounded-xl">
        <canvas id="tempChart"></canvas>
    </div>

    <div id="explanationBox" class="info-box p-4 bg-yellow-100 border-l-4 border-yellow-500">
        <h3 class="text-lg font-semibold text-yellow-800" id="windowDetails">準備就緒</h3>
        <p id="calculationDetails" class="mt-2 text-yellow-700">點擊「開始演示」觀看 N=4 嚴格移動平均的計算過程。</p>
    </div>

    <div id="dataTableContainer" class="mt-8 mx-auto max-w-4xl">
        <h3 class="text-xl font-semibold mb-3 text-gray-700">同步數據明細表 (N=4)</h3>
        <div id="tableWrapper" class="max-h-96 overflow-y-hidden overflow-x-auto rounded-lg border border-gray-300 shadow-md">
            <table id="dataTable" class="bg-white whitespace-nowrap">
                </table>
        </div>
    </div>


    <script>
        // 1. 數據準備
        const rawData = [
            { time: "11:15", temp: 32.00 }, { time: "11:30", temp: 32.00 }, 
            { time: "11:45", temp: 35.00 }, { time: "12:00", temp: 33.00 }, 
            { time: "12:15", temp: 33.00 }, { time: "12:30", temp: 33.00 }, 
            { time: "12:45", temp: 29.00 }, { time: "13:00", temp: 33.00 }, 
            { time: "13:15", temp: 33.00 }, { time: "13:30", temp: 33.00 }, 
            { time: "13:45", temp: 32.00 }, { time: "14:00", temp: 32.00 }, 
            { time: "14:15", temp: 32.00 }, { time: "14:30", temp: 32.00 }, 
            { time: "14:45", temp: 33.00 }, { time: "15:00", temp: 32.00 }, 
            { time: "15:15", temp: 32.00 }, { time: "15:30", temp: 32.00 }, 
            { time: "15:45", temp: 33.00 }, { time: "16:00", temp: 33.00 }, 
            { time: "16:15", temp: 33.00 }, { time: "16:30", temp: 32.00 }, 
            { time: "16:45", temp: 31.00 }, { time: "17:00", temp: 31.00 }, 
            { time: "17:15", temp: 31.00 }, { time: "17:30", temp: 31.00 }, 
            { time: "17:45", temp: 30.00 }, { time: "18:00", temp: 30.00 }
        ];

        // *** 修改點：N=4 ***
        const WINDOW_SIZE = 4;
        const MA_DATA = [];
        const labels = rawData.map(d => d.time);
        const rawTemps = rawData.map(d => d.temp);
        
        // 2. 計算移動平均 (*** 修改點：嚴格模式 ***)
        function calculateMovingAverage() {
            MA_DATA.length = 0; 
            for (let i = 0; i < rawData.length; i++) {
                // 如果當前索引 i 小於 N-1 (例如 N=4，索引0,1,2時數據不足)
                if (i < WINDOW_SIZE - 1) {
                    MA_DATA.push(null); // 推入 null，Chart.js 不會繪製
                } else {
                    // 數據足夠，取包含自己在內的往前 WINDOW_SIZE 個
                    let sum = 0;
                    for (let j = 0; j < WINDOW_SIZE; j++) {
                        sum += rawData[i - j].temp;
                    }
                    MA_DATA.push(sum / WINDOW_SIZE);
                }
            }
        }

        // 3. 渲染數據表格
        function renderTable() {
            const rowHeaders = [
                '時間 (Time)', 
                '原始溫度 (°C)', 
                '移動平均 (MA)'
            ];

            let tableHTML = `
                <thead>
                    <tr class="bg-gray-200 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider sticky top-0">
                        <th class="px-4 py-3 min-w-[150px]">指標 (Metric)</th>
            `;
            
            for (let i = 0; i < rawData.length; i++) {
                tableHTML += `<th class="px-4 py-3 text-center min-w-[80px]">${i + 1}</th>`;
            }
            tableHTML += `
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-gray-200 text-sm">
            `;

            // Row 1: 時間
            tableHTML += `<tr class="hover:bg-gray-50 border-b border-gray-300"><td class="px-4 py-2 font-semibold whitespace-nowrap">${rowHeaders[0]}</td>`;
            for (let i = 0; i < rawData.length; i++) {
                tableHTML += `<td class="px-4 py-2 whitespace-nowrap text-center">${rawData[i].time}</td>`;
            }
            tableHTML += `</tr>`;
            
            // Row 2: 原始溫度
            tableHTML += `<tr class="hover:bg-gray-50 border-b border-gray-300"><td class="px-4 py-2 font-semibold whitespace-nowrap text-red-600">${rowHeaders[1]}</td>`;
            for (let i = 0; i < rawData.length; i++) {
                tableHTML += `<td id="raw-data-${i}" class="px-4 py-2 whitespace-nowrap text-center text-red-600">${rawData[i].temp.toFixed(2)}</td>`;
            }
            tableHTML += `</tr>`;

            // Row 3: 移動平均
            tableHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-2 font-semibold whitespace-nowrap text-blue-600">${rowHeaders[2]}</td>`;
            for (let i = 0; i < rawData.length; i++) {
                // *** 修改點：如果值是 null，顯示 '--' ***
                const maValue = (MA_DATA[i] !== null) ? MA_DATA[i].toFixed(2) : '<span class="text-gray-300">--</span>';
                tableHTML += `<td id="ma-data-${i}" class="px-4 py-2 whitespace-nowrap text-center text-blue-600">${maValue}</td>`;
            }
            tableHTML += `</tr>`;

            tableHTML += `</tbody>`;
            document.getElementById('dataTable').innerHTML = tableHTML;
        }

        // --- Chart.js 初始化 ---
        let chartInstance = null;
        let stepIndex = 0;
        let animationInterval = null;
        const SPEED = 1000;

        let rawPointBackgrounds = [];
        let maPointBackgrounds = [];

        function initializeChart() {
            calculateMovingAverage();
            renderTable();

            rawPointBackgrounds = Array(rawData.length).fill('rgba(220, 53, 69, 0.7)'); 
            maPointBackgrounds = Array(rawData.length).fill('rgba(0, 123, 255, 0)'); 

            const ctx = document.getElementById('tempChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '原始溫度',
                            data: rawTemps,
                            borderColor: 'rgba(220, 53, 69, 0.5)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 4,
                            pointBackgroundColor: rawPointBackgrounds,
                            pointBorderColor: 'transparent',
                            tension: 0,
                            spanGaps: true,
                        },
                        {
                            label: '移動平均 (N=4)',
                            data: MA_DATA,
                            borderColor: 'rgba(0, 123, 255, 1)',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: maPointBackgrounds,
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            tension: 0.1,
                            fill: false,
                            // *** Chart.js 自動處理 null，這裡不需要特別設定 spanGaps ***
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    scales: {
                        x: {
                            title: { display: true, text: '時間' },
                            ticks: { 
                                callback: function(val, index) {
                                    return index % 3 === 0 ? this.getLabelForValue(val) : '';
                                },
                            }
                        },
                        y: {
                            title: { display: true, text: '溫度 (°C)' },
                            min: 25, 
                            max: 40,
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
            updateChartStep(stepIndex);
        }

        // 4. 動畫更新邏輯 (*** 修改點：支援嚴格模式顯示 ***)
        function updateChartStep(index) {
            
            // 重置
            rawPointBackgrounds = Array(rawData.length).fill('rgba(220, 53, 69, 0.7)'); 
            maPointBackgrounds = Array(rawData.length).fill('rgba(0, 123, 255, 0)'); 

            document.querySelectorAll('#tableBody td').forEach(cell => {
                cell.classList.remove('highlight-active-raw', 'highlight-ma', 'highlight-waiting');
            });

            let calculationText = '';

            if (index < rawData.length) {
                
                // 判斷是否為「無效/累積階段」(Strict Mode check)
                const isAccumulating = (index < WINDOW_SIZE - 1);

                if (isAccumulating) {
                    // *** 情況 A: 數據不足 N (嚴格模式下不計算) ***
                    
                    // 只高亮當前這個原始點 (表示讀取中)
                    rawPointBackgrounds[index] = 'rgba(108, 117, 125, 1)'; // 灰色
                    
                    // 表格高亮：等待中
                    const rawCell = document.getElementById(`raw-data-${index}`);
                    if (rawCell) rawCell.classList.add('highlight-waiting');

                    calculationText = `
                        <strong class="text-xl">當前時間:</strong> ${rawData[index].time} <br>
                        <strong class="text-gray-500">狀態:</strong> 數據累積中 (${index + 1}/${WINDOW_SIZE}) <br>
                        <span class="text-gray-400">嚴格模式下，需集滿 ${WINDOW_SIZE} 筆數據才開始計算。</span>
                    `;

                } else {
                    // *** 情況 B: 數據足夠 (開始計算) ***
                    
                    const start = index - WINDOW_SIZE + 1;
                    const currentWindow = rawData.slice(start, index + 1);
                    
                    let sumValues = [];
                    // 高亮視窗內的原始數據 (綠色)
                    for (let j = start; j <= index; j++) {
                        rawPointBackgrounds[j] = 'rgba(40, 167, 69, 1)'; 
                        sumValues.push(rawData[j].temp);

                        const rawCell = document.getElementById(`raw-data-${j}`);
                        if (rawCell) rawCell.classList.add('highlight-active-raw');
                    }
                    
                    // 高亮計算出的 MA 點 (藍色)
                    maPointBackgrounds[index] = 'rgba(0, 123, 255, 1)'; 
                    const maCell = document.getElementById(`ma-data-${index}`);
                    if (maCell) maCell.classList.add('highlight-ma'); 

                    // 說明文字
                    const sumText = sumValues.map(t => t.toFixed(2)).join(' + ');
                    const result = MA_DATA[index].toFixed(2);
                    
                    calculationText = `
                        <strong class="text-xl">當前時間:</strong> ${rawData[index].time} <br>
                        <strong class="text-green-700">窗口數據 (N=${WINDOW_SIZE}):</strong> [${sumText}] <br>
                        <strong class="text-lg">計算過程:</strong> (${sumText}) / ${WINDOW_SIZE} <br>
                        <strong class="text-blue-600 text-2xl">MA 值: ${result}</strong>
                    `;
                }

            } else {
                 calculationText = '<strong class="text-xl text-green-700">演示結束。</strong> <br> 注意看 MA 線 (藍色) 是如何比原始數據 (紅色) 晚了幾步才開始出現的。';
            }

            chartInstance.data.datasets[0].pointBackgroundColor = rawPointBackgrounds;
            chartInstance.data.datasets[1].pointBackgroundColor = maPointBackgrounds;
            chartInstance.update('none'); 

            document.getElementById('calculationDetails').innerHTML = calculationText;
            document.getElementById('windowDetails').textContent = `N=${WINDOW_SIZE} 窗口 (當前數據點: ${Math.min(index + 1, rawData.length)}/${rawData.length})`;

            // 滾動表格
            const tableWrapper = document.getElementById('tableWrapper');
            if (tableWrapper && index >= 0) {
                const currentColumnHeader = document.getElementById('dataTable').querySelector(`thead th:nth-child(${index + 2})`); 
                if (currentColumnHeader) {
                    const targetOffset = currentColumnHeader.offsetLeft;
                    const containerWidth = tableWrapper.clientWidth;
                    tableWrapper.scrollLeft = targetOffset - (containerWidth / 2) + (currentColumnHeader.clientWidth / 2);
                }
            }
        }

        // 5. 控制功能
        function startAnimation() {
            if (animationInterval) return;
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            document.getElementById('resetButton').disabled = true;

            animationInterval = setInterval(() => {
                if (stepIndex >= rawData.length) {
                    stopAnimation();
                    document.getElementById('resetButton').disabled = false;
                    return;
                }
                updateChartStep(stepIndex);
                stepIndex++;
            }, SPEED);
        }

        function stopAnimation() {
            clearInterval(animationInterval);
            animationInterval = null;
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('resetButton').disabled = false;
        }

        function resetChart() {
            stopAnimation();
            stepIndex = 0;
            initializeChart();
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('resetButton').disabled = true;
        }

        window.onload = function() {
            document.getElementById('chartContainer').style.height = document.getElementById('chartContainer').clientWidth * 0.5 + 'px';
            initializeChart();
        }

        window.addEventListener('resize', function() {
             document.getElementById('chartContainer').style.height = document.getElementById('chartContainer').clientWidth * 0.5 + 'px';
             if (chartInstance) chartInstance.resize();
        });

    </script>
</body>
</html>